<header class="site-header">
  <div class="wrap header-inner">
    <a class="brand" href="{{ '/' | relative_url }}">{{ site.title }}</a>

    {% assign current_raw = page.url | replace: 'index.html', '' | replace: '//', '/' %}
    {% if current_raw == '' %}{% assign current_raw = '/' %}{% endif %}
    {% assign current_path = current_raw | append: '/' | replace: '//', '/' %}

    <nav class="nav">
      {% for item in site.nav %}
        {% assign target_raw = item.url | replace: 'index.html', '' | replace: '//', '/' %}
        {% if target_raw == '' %}{% assign target_raw = '/' %}{% endif %}
        {% assign target_path = target_raw | append: '/' | replace: '//', '/' %}
        <a href="{{ target_path | relative_url }}"
           {% if current_path == target_path %}aria-current="page"{% endif %}>
          {{ item.name }}
        </a>

        {% if forloop.index == 1 %}
          <span id="next-event-slot"
                data-next-label="{{ site.nav_next_label | default: 'Next Event' | escape }}">
          </span>
        {% endif %}
      {% endfor %}
    </nav>

    {% assign empty_array = '' | split: '' %}
    {% assign events_coll = site.events | default: empty_array %}
    {% assign events_sorted = events_coll | sort: 'date' %}

    <script id="events-data" type="application/json">[
    {%- for ev in events_sorted -%}
      {
        "url": {{ ev.url | replace: 'index.html','' | append:'/' | replace:'//','/' | relative_url | jsonify }},
        "iso": {{ ev.date | date: "%Y-%m-%dT%H:%M:%S%:z" | jsonify }},
        "title": {{ ev.title | jsonify }}
      }{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
    ]</script>

    <script>
      (function () {
        function ymdInKST(date) {
          var kst = new Date(date.getTime() + 9 * 60 * 60 * 1000);
          return kst.toISOString().slice(0, 10);
        }
        function ymdFromISOinKST(iso) {
          var d = new Date(iso);
          return ymdInKST(d);
        }

        var todayKST = ymdInKST(new Date());

        var dataEl = document.getElementById('events-data');
        var events = [];
        if (dataEl) {
          try { events = JSON.parse(dataEl.textContent || '[]'); } catch (e) { events = []; }
        }

        var filtered = events.map(function (ev) {
          return { url: ev.url, iso: ev.iso, title: ev.title, ymd: ymdFromISOinKST(ev.iso) };
        }).filter(function (ev) {
          return ev.ymd >= todayKST;
        }).sort(function (a, b) {
          return a.ymd.localeCompare(b.ymd);
        });

        var next = filtered.length ? filtered[0] : null;

        var slot = document.getElementById('next-event-slot');
        if (!slot) return;

        if (next) {
          var a = document.createElement('a');
          a.href = next.url;
          a.className = 'next-event';
          var label = slot.getAttribute('data-next-label') || 'Next Event';
          a.textContent = label;
          function normalize(p) { return p.replace(/\/+$/, '/'); }
          if (normalize(location.pathname) === normalize(new URL(a.href, location.href).pathname)) {
            a.setAttribute('aria-current', 'page');
          }
          slot.replaceWith(a);
        } else {
          slot.remove();
        }
      })();
    </script>
  </div>
</header>